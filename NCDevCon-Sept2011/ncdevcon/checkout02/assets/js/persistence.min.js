&persisten&
if(typeof exports!=='undefined'){exports.createPersistence=function(){return initPersistence({})}
var singleton;exports.__defineGetter__("persistence",function(){if(!singleton)
singleton=exports.createPersistence();return singleton;});}
else{window=window||{};window.persistence=initPersistence(window.persistence||{});}
function initPersistence(persistence){if(persistence.isImmutable)
return persistence;persistence.isImmutable=function(fieldName){return(fieldName=="id");};persistence.defineProp=function(scope,field,setterCallback,getterCallback){scope.__defineSetter__(field,function(value){setterCallback(value);});scope.__defineGetter__(field,function(){return getterCallback();});};persistence.set=function(scope,fieldName,value){if(persistence.isImmutable(fieldName))throw new Error("immutable field: "+fieldName);scope[fieldName]=value;};persistence.get=function(arg1,arg2){return(arguments.length==1)?arg1:arg1[arg2];};(function(){var entityMeta={};var entityClassCache={};persistence.getEntityMeta=function(){return entityMeta;}
persistence.trackedObjects={};persistence.objectsToRemove={};persistence.objectsRemoved=[];persistence.globalPropertyListeners={};persistence.queryCollectionCache={};persistence.getObjectsToRemove=function(){return this.objectsToRemove;};persistence.getTrackedObjects=function(){return this.trackedObjects;};persistence.entityDecoratorHooks=[];persistence.flushHooks=[];persistence.schemaSyncHooks=[];persistence.debug=true;persistence.subscribeToGlobalPropertyListener=function(coll,entityName,property){var key=entityName+'__'+property;if(key in this.globalPropertyListeners){var listeners=this.globalPropertyListeners[key];for(var i=0;i<listeners.length;i++){if(listeners[i]===coll){return;}}
this.globalPropertyListeners[key].push(coll);}else{this.globalPropertyListeners[key]=[coll];}}
persistence.unsubscribeFromGlobalPropertyListener=function(coll,entityName,property){var key=entityName+'__'+property;var listeners=this.globalPropertyListeners[key];for(var i=0;i<listeners.length;i++){if(listeners[i]===coll){listeners.splice(i,1);return;}}}
persistence.propertyChanged=function(obj,property,oldValue,newValue){if(!this.trackedObjects[obj.id])return;var entityName=obj._type;var key=entityName+'__'+property;if(key in this.globalPropertyListeners){var listeners=this.globalPropertyListeners[key];for(var i=0;i<listeners.length;i++){var coll=listeners[i];var dummyObj=obj._data;dummyObj[property]=oldValue;var matchedBefore=coll._filter.match(dummyObj);dummyObj[property]=newValue;var matchedAfter=coll._filter.match(dummyObj);if(matchedBefore!=matchedAfter){coll.triggerEvent('change',coll,obj);}}}}
persistence.objectRemoved=function(obj){var entityName=obj._type;if(this.queryCollectionCache[entityName]){var colls=this.queryCollectionCache[entityName];for(var key in colls){if(colls.hasOwnProperty(key)){var coll=colls[key];if(coll._filter.match(obj)){coll.triggerEvent('change',coll,obj);}}}}}
function getMeta(entityName){return entityMeta[entityName];}
persistence.getMeta=getMeta;function Session(conn){this.trackedObjects={};this.objectsToRemove={};this.objectsRemoved=[];this.globalPropertyListeners={};this.queryCollectionCache={};this.conn=conn;}
Session.prototype=persistence;persistence.Session=Session;persistence.define=function(entityName,fields){if(entityMeta[entityName]){return getEntity(entityName);}
var meta={name:entityName,fields:fields,isMixin:false,indexes:[],hasMany:{},hasOne:{}};entityMeta[entityName]=meta;return getEntity(entityName);};persistence.isDefined=function(entityName){return!!entityMeta[entityName];}
persistence.defineMixin=function(mixinName,fields){var Entity=this.define(mixinName,fields);Entity.meta.isMixin=true;return Entity;};persistence.isTransaction=function(obj){return!obj||(obj&&obj.executeSql);};persistence.isSession=function(obj){return!obj||(obj&&obj.schemaSync);};persistence.add=function(obj){if(!obj)return;if(!this.trackedObjects[obj.id]){this.trackedObjects[obj.id]=obj;if(obj._new){for(var p in obj._data){if(obj._data.hasOwnProperty(p)){this.propertyChanged(obj,p,undefined,obj._data[p]);}}}}
return this;};persistence.remove=function(obj){if(!this.objectsToRemove[obj.id]){this.objectsToRemove[obj.id]=obj;}
this.objectsRemoved.push({id:obj.id,entity:obj._type});this.objectRemoved(obj);return this;};persistence.clean=function(){this.trackedObjects={};this.objectsToRemove={};this.objectsRemoved=[];this.globalPropertyListeners={};this.queryCollectionCache={};};persistence.asyncForEach=function(array,fn,callback){array=array.slice(0);function processOne(){var item=array.pop();fn(item,function(result,err){if(array.length>0){processOne();}else{callback(result,err);}});}
if(array.length>0){processOne();}else{callback();}};persistence.asyncParForEach=function(array,fn,callback){var completed=0;var arLength=array.length;if(arLength===0){callback();}
for(var i=0;i<arLength;i++){fn(array[i],function(result,err){completed++;if(completed===arLength){callback(result,err);}});}};function getEntity(entityName){if(entityClassCache[entityName]){return entityClassCache[entityName];}
var meta=entityMeta[entityName];function Entity(session,obj,noEvents){var args=argspec.getArgs(arguments,[{name:"session",optional:true,check:persistence.isSession,defaultValue:persistence},{name:"obj",optional:true,check:function(obj){return obj;},defaultValue:{}}]);if(meta.isMixin)
throw new Error("Cannot instantiate mixin");session=args.session;obj=args.obj;var that=this;this.id=obj.id||persistence.createUUID();this._new=true;this._type=entityName;this._dirtyProperties={};this._data={};this._data_obj={};this._session=session||persistence;this.subscribers={};for(var field in meta.fields){(function(){if(meta.fields.hasOwnProperty(field)){var f=field;persistence.defineProp(that,f,function(val){var oldValue=that._data[f];if(oldValue!==val||(oldValue&&val&&oldValue.getTime&&val.getTime)){that._data[f]=val;that._dirtyProperties[f]=oldValue;that.triggerEvent('set',that,f,val);that.triggerEvent('change',that,f,val);session.propertyChanged(that,f,oldValue,val);}},function(){return that._data[f];});that._data[field]=defaultValue(meta.fields[field]);}}());}
for(var it in meta.hasOne){if(meta.hasOne.hasOwnProperty(it)){(function(){var ref=it;var mixinClass=meta.hasOne[it].type.meta.isMixin?ref+'_class':null;persistence.defineProp(that,ref,function(val){var oldValue=that._data[ref];var oldValueObj=that._data_obj[ref]||session.trackedObjects[that._data[ref]];if(val==null){that._data[ref]=null;that._data_obj[ref]=undefined;if(mixinClass)
that[mixinClass]='';}else if(val.id){that._data[ref]=val.id;that._data_obj[ref]=val;if(mixinClass)
that[mixinClass]=val._type;session.add(val);session.add(that);}else{that._data[ref]=val;}
that._dirtyProperties[ref]=oldValue;that.triggerEvent('set',that,ref,val);that.triggerEvent('change',that,ref,val);if(meta.hasOne[ref].inverseProperty){var newVal=that[ref];if(newVal){var inverse=newVal[meta.hasOne[ref].inverseProperty];if(inverse.list&&inverse._filter){inverse.triggerEvent('change',that,ref,val);}}
if(oldValueObj){console.log("OldValue",oldValueObj);var inverse=oldValueObj[meta.hasOne[ref].inverseProperty];if(inverse.list&&inverse._filter){inverse.triggerEvent('change',that,ref,val);}}}},function(){if(!that._data[ref]){return null;}else if(that._data_obj[ref]!==undefined){return that._data_obj[ref];}else if(that._data[ref]&&session.trackedObjects[that._data[ref]]){that._data_obj[ref]=session.trackedObjects[that._data[ref]];return that._data_obj[ref];}else{throw new Error("Property '"+ref+"' with id: "+that._data[ref]+" not fetched, either prefetch it or fetch it manually.");}});}());}}
for(var it in meta.hasMany){if(meta.hasMany.hasOwnProperty(it)){(function(){var coll=it;if(meta.hasMany[coll].manyToMany){persistence.defineProp(that,coll,function(val){if(val&&val._items){var items=val._items;for(var i=0;i<items.length;i++){persistence.get(that,coll).add(items[i]);}}else{throw new Error("Not yet supported.");}},function(){if(that._data[coll]){return that._data[coll];}else{var rel=meta.hasMany[coll];var inverseMeta=rel.type.meta;var inv=inverseMeta.hasMany[rel.inverseProperty];var direct=rel.mixin?rel.mixin.meta.name:meta.name;var inverse=inv.mixin?inv.mixin.meta.name:inverseMeta.name;var queryColl=new persistence.ManyToManyDbQueryCollection(session,inverseMeta.name);queryColl.initManyToMany(that,coll);queryColl._manyToManyFetch={table:rel.tableName,prop:direct+'_'+coll,inverseProp:inverse+'_'+rel.inverseProperty,id:that.id};that._data[coll]=queryColl;return session.uniqueQueryCollection(queryColl);}});}else{persistence.defineProp(that,coll,function(val){if(val&&val._items){var items=val._items;for(var i=0;i<items.length;i++){persistence.get(that,coll).add(items[i]);}}else{throw new Error("Not yet supported.");}},function(){if(that._data[coll]){return that._data[coll];}else{var queryColl=session.uniqueQueryCollection(new persistence.DbQueryCollection(session,meta.hasMany[coll].type.meta.name).filter(meta.hasMany[coll].inverseProperty,'=',that));that._data[coll]=queryColl;return queryColl;}});}}());}}
if(this.initialize){this.initialize();}
for(var f in obj){if(obj.hasOwnProperty(f)){if(f!=='id'){persistence.set(that,f,obj[f]);}}}}
Entity.prototype=new Observable();Entity.meta=meta;Entity.prototype.equals=function(other){return this.id==other.id;};Entity.prototype.toJSON=function(){var json={id:this.id};for(var p in this._data){if(this._data.hasOwnProperty(p)){if(typeof this._data[p]=="object"&&this._data[p]!=null){if(this._data[p].toJSON!=undefined){json[p]=this._data[p].toJSON();}}else{json[p]=this._data[p];}}}
return json;};Entity.prototype.selectJSON=function(tx,props,callback){var that=this;var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"props",optional:false},{name:"callback",optional:false}]);tx=args.tx;props=args.props;callback=args.callback;if(!tx){this._session.transaction(function(tx){that.selectJSON(tx,props,callback);});return;}
var includeProperties={};props.forEach(function(prop){var current=includeProperties;var parts=prop.split('.');for(var i=0;i<parts.length;i++){var part=parts[i];if(i===parts.length-1){if(part==='*'){current.id=true;for(var p in meta.fields){if(meta.fields.hasOwnProperty(p)){current[p]=true;}}
for(var p in meta.hasOne){if(meta.hasOne.hasOwnProperty(p)){current[p]=true;}}
for(var p in meta.hasMany){if(meta.hasMany.hasOwnProperty(p)){current[p]=true;}}}else if(part[0]==='['){part=part.substring(1,part.length-1);var propList=part.split(/,\s*/);propList.forEach(function(prop){current[prop]=true;});}else{current[part]=true;}}else{current[part]=current[part]||{};current=current[part];}}});buildJSON(this,tx,includeProperties,callback);};function buildJSON(that,tx,includeProperties,callback){var session=that._session;var properties=[];var meta=getMeta(that._type);var fieldSpec=meta.fields;for(var p in includeProperties){if(includeProperties.hasOwnProperty(p)){properties.push(p);}}
var cheapProperties=[];var expensiveProperties=[];properties.forEach(function(p){if(includeProperties[p]===true&&!meta.hasMany[p]){cheapProperties.push(p);}else{expensiveProperties.push(p);}});var itemData=that._data;var item={};cheapProperties.forEach(function(p){if(p==='id'){item.id=that.id;}else if(meta.hasOne[p]){item[p]=itemData[p]?{id:itemData[p]}:null;}else{item[p]=persistence.entityValToJson(itemData[p],fieldSpec[p]);}});properties=expensiveProperties.slice();persistence.asyncForEach(properties,function(p,callback){if(meta.hasOne[p]){that.fetch(tx,p,function(obj){if(obj){buildJSON(obj,tx,includeProperties[p],function(result){item[p]=result;callback();});}else{item[p]=null;callback();}});}else if(meta.hasMany[p]){persistence.get(that,p).list(function(objs){item[p]=[];persistence.asyncForEach(objs,function(obj,callback){var obj=objs.pop();if(includeProperties[p]===true){item[p].push({id:obj.id});callback();}else{buildJSON(obj,tx,includeProperties[p],function(result){item[p].push(result);callback();});}},callback);});}},function(){callback(item);});};Entity.prototype.fetch=function(tx,rel,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'rel',optional:false,check:argspec.hasType('string')},{name:'callback',optional:false,check:argspec.isCallback()}]);tx=args.tx;rel=args.rel;callback=args.callback;var that=this;var session=this._session;if(!tx){session.transaction(function(tx){that.fetch(tx,rel,callback);});return;}
if(!this._data[rel]){if(callback){callback(null);}}else if(this._data_obj[rel]){if(callback){callback(this._data_obj[rel]);}}else{var type=meta.hasOne[rel].type;if(type.meta.isMixin){type=getEntity(this._data[rel+'_class']);}
type.load(session,tx,this._data[rel],function(obj){that._data_obj[rel]=obj;if(callback){callback(obj);}});}};Entity.prototype.markDirty=function(prop){this._dirtyProperties[prop]=true;};Entity.all=function(session){var args=argspec.getArgs(arguments,[{name:'session',optional:true,check:persistence.isSession,defaultValue:persistence}]);session=args.session;return session.uniqueQueryCollection(new AllDbQueryCollection(session,entityName));};Entity.fromSelectJSON=function(session,tx,jsonObj,callback){var args=argspec.getArgs(arguments,[{name:'session',optional:true,check:persistence.isSession,defaultValue:persistence},{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'jsonObj',optional:false},{name:'callback',optional:false,check:argspec.isCallback()}]);session=args.session;tx=args.tx;jsonObj=args.jsonObj;callback=args.callback;if(!tx){session.transaction(function(tx){Entity.fromSelectJSON(session,tx,jsonObj,callback);});return;}
if(typeof jsonObj==='string'){jsonObj=JSON.parse(jsonObj);}
if(!jsonObj){callback(null);return;}
function loadedObj(obj){if(!obj){obj=new Entity(session);if(jsonObj.id){obj.id=jsonObj.id;}}
session.add(obj);var expensiveProperties=[];for(var p in jsonObj){if(jsonObj.hasOwnProperty(p)){if(p==='id'){continue;}else if(meta.fields[p]){persistence.set(obj,p,persistence.jsonToEntityVal(jsonObj[p],meta.fields[p]));}else if(meta.hasOne[p]||meta.hasMany[p]){expensiveProperties.push(p);}}}
persistence.asyncForEach(expensiveProperties,function(p,callback){if(meta.hasOne[p]){meta.hasOne[p].type.fromSelectJSON(session,tx,jsonObj[p],function(result){persistence.set(obj,p,result);callback();});}else if(meta.hasMany[p]){var coll=persistence.get(obj,p);var ar=jsonObj[p].slice(0);var PropertyEntity=meta.hasMany[p].type;coll.list(tx,function(currentItems){persistence.asyncForEach(ar,function(item,callback){PropertyEntity.fromSelectJSON(session,tx,item,function(result){for(var i=0;i<currentItems.length;i++){if(currentItems[i].id===result.id){callback();return;}}
coll.add(result);callback();});},function(){callback();});});}},function(){callback(obj);});}
if(jsonObj.id){Entity.load(session,tx,jsonObj.id,loadedObj);}else{loadedObj(new Entity(session));}};Entity.load=function(session,tx,id,callback){var args=argspec.getArgs(arguments,[{name:'session',optional:true,check:persistence.isSession,defaultValue:persistence},{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'id',optional:false,check:argspec.hasType('string')},{name:'callback',optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);Entity.findBy(args.session,args.tx,"id",args.id,args.callback);};Entity.findBy=function(session,tx,property,value,callback){var args=argspec.getArgs(arguments,[{name:'session',optional:true,check:persistence.isSession,defaultValue:persistence},{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'property',optional:false,check:argspec.hasType('string')},{name:'value',optional:false},{name:'callback',optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);session=args.session;tx=args.tx;property=args.property;value=args.value;callback=args.callback;if(property==='id'&&value in session.trackedObjects){callback(session.trackedObjects[value]);return;}
if(!tx){session.transaction(function(tx){Entity.findBy(session,tx,property,value,callback);});return;}
Entity.all(session).filter(property,"=",value).one(tx,function(obj){callback(obj);});}
Entity.index=function(cols,options){var opts=options||{};if(typeof cols=="string"){cols=[cols];}
opts.columns=cols;meta.indexes.push(opts);};Entity.hasMany=function(collName,otherEntity,invRel){var otherMeta=otherEntity.meta;if(otherMeta.hasMany[invRel]){var tableName=meta.name+"_"+collName+"_"+otherMeta.name;var inverseTableName=otherMeta.name+'_'+invRel+'_'+meta.name;if(tableName>inverseTableName){tableName=inverseTableName;}
meta.hasMany[collName]={type:otherEntity,inverseProperty:invRel,manyToMany:true,tableName:tableName};otherMeta.hasMany[invRel]={type:Entity,inverseProperty:collName,manyToMany:true,tableName:tableName};delete meta.hasOne[collName];delete meta.fields[collName+"_class"];}else{meta.hasMany[collName]={type:otherEntity,inverseProperty:invRel};otherMeta.hasOne[invRel]={type:Entity,inverseProperty:collName};if(meta.isMixin)
otherMeta.fields[invRel+"_class"]=persistence.typeMapper?persistence.typeMapper.classNameType:"TEXT";}}
Entity.hasOne=function(refName,otherEntity,inverseProperty){meta.hasOne[refName]={type:otherEntity,inverseProperty:inverseProperty};if(otherEntity.meta.isMixin)
meta.fields[refName+"_class"]=persistence.typeMapper?persistence.typeMapper.classNameType:"TEXT";};Entity.is=function(mixin){var mixinMeta=mixin.meta;if(!mixinMeta.isMixin)
throw new Error("not a mixin: "+mixin);mixin.meta.mixedIns=mixin.meta.mixedIns||[];mixin.meta.mixedIns.push(meta);for(var field in mixinMeta.fields){if(mixinMeta.fields.hasOwnProperty(field))
meta.fields[field]=mixinMeta.fields[field];}
for(var it in mixinMeta.hasOne){if(mixinMeta.hasOne.hasOwnProperty(it))
meta.hasOne[it]=mixinMeta.hasOne[it];}
for(var it in mixinMeta.hasMany){if(mixinMeta.hasMany.hasOwnProperty(it)){mixinMeta.hasMany[it].mixin=mixin;meta.hasMany[it]=mixinMeta.hasMany[it];}}}
var fns=persistence.entityDecoratorHooks;for(var i=0;i<fns.length;i++){fns[i](Entity);}
entityClassCache[entityName]=Entity;return Entity;}
persistence.jsonToEntityVal=function(value,type){if(type){switch(type){case'DATE':if(typeof value==='number'){return new Date(value*1000);}else{return null;}
break;default:return value;}}else{return value;}};persistence.entityValToJson=function(value,type){if(type){switch(type){case'DATE':if(value){value=new Date(value);return Math.round(value.getTime()/1000);}else{return null;}
break;default:return value;}}else{return value;}};persistence.dump=function(tx,entities,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'entities',optional:true,check:function(obj){return!obj||(obj&&obj.length&&!obj.apply);},defaultValue:null},{name:'callback',optional:false,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;entities=args.entities;callback=args.callback;if(!entities){entities=[];for(var e in entityClassCache){if(entityClassCache.hasOwnProperty(e)){entities.push(entityClassCache[e]);}}}
var result={};persistence.asyncParForEach(entities,function(Entity,callback){Entity.all().list(tx,function(all){var items=[];persistence.asyncParForEach(all,function(e,callback){var rec={};var fields=Entity.meta.fields;for(var f in fields){if(fields.hasOwnProperty(f)){rec[f]=persistence.entityValToJson(e._data[f],fields[f]);}}
var refs=Entity.meta.hasOne;for(var r in refs){if(refs.hasOwnProperty(r)){rec[r]=e._data[r];}}
var colls=Entity.meta.hasMany;var collArray=[];for(var coll in colls){if(colls.hasOwnProperty(coll)){collArray.push(coll);}}
persistence.asyncParForEach(collArray,function(collP,callback){var coll=persistence.get(e,collP);coll.list(tx,function(results){rec[collP]=results.map(function(r){return r.id;});callback();});},function(){rec.id=e.id;items.push(rec);callback();});},function(){result[Entity.meta.name]=items;callback();});});},function(){callback(result);});};persistence.load=function(tx,dump,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'dump',optional:false},{name:'callback',optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;dump=args.dump;callback=args.callback;var finishedCount=0;var collItemsToAdd=[];var session=this;for(var entityName in dump){if(dump.hasOwnProperty(entityName)){var Entity=getEntity(entityName);var fields=Entity.meta.fields;var instances=dump[entityName];for(var i=0;i<instances.length;i++){var instance=instances[i];var ent=new Entity();ent.id=instance.id;for(var p in instance){if(instance.hasOwnProperty(p)){if(persistence.isImmutable(p)){ent[p]=instance[p];}else if(Entity.meta.hasMany[p]){var many=Entity.meta.hasMany[p];if(many.manyToMany&&Entity.meta.name<many.type.meta.name){continue;}
var coll=persistence.get(ent,p);if(instance[p].length>0){instance[p].forEach(function(it){collItemsToAdd.push({Entity:Entity,coll:coll,id:it});});}}else{persistence.set(ent,p,persistence.jsonToEntityVal(instance[p],fields[p]));}}}
this.add(ent);}}}
session.flush(tx,function(){persistence.asyncForEach(collItemsToAdd,function(collItem,callback){collItem.Entity.load(session,tx,collItem.id,function(obj){collItem.coll.add(obj);callback();});},function(){session.flush(tx,callback);});});};persistence.dumpToJson=function(tx,entities,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'entities',optional:true,check:function(obj){return obj&&obj.length&&!obj.apply;},defaultValue:null},{name:'callback',optional:false,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;entities=args.entities;callback=args.callback;this.dump(tx,entities,function(obj){callback(JSON.stringify(obj));});};persistence.loadFromJson=function(tx,jsonDump,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'jsonDump',optional:false},{name:'callback',optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;jsonDump=args.jsonDump;callback=args.callback;this.load(tx,JSON.parse(jsonDump),callback);};function createUUID(){if(persistence.typeMapper&ce.typeMapper.newUuid){return persistence.typeMapper.newUuid();}
var s=[];var hexDigits="0123456789ABCDEF";for(var i=0;i<32;i++){s[i]=hexDigits.substr(Math.floor(Math.random()*0x10),1);}
s[12]="4";s[16]=hexDigits.substr((s[16]&0x3)|0x8,1);var uuid=s.join("");return uuid;}
persistence.createUUID=createUUID;function defaultValue(type){if(persistence.typeMapper&&persistence.typeMapper.defaultValue){return persistence.typeMapper.defaultValue(type);}
switch(type){case"TEXT":return"";case"BOOL":return false;default:if(type.indexOf("INT")!==-1){return 0;}else if(type.indexOf("CHAR")!==-1){return"";}else{return null;}}}
function arrayContains(ar,item){var l=ar.length;for(var i=0;i<l;i++){var el=ar[i];if(el.equals&&el.equals(item)){return true;}else if(el===item){return true;}}
return false;}
function arrayRemove(ar,item){var l=ar.length;for(var i=0;i<l;i++){var el=ar[i];if(el.equals&&el.equals(item)){ar.splice(i,1);}else if(el===item){ar.splice(i,1);}}}
function Subscription(obj,eventType,fn){this.obj=obj;this.eventType=eventType;this.fn=fn;}
Subscription.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn);};function Observable(){this.subscribers={};}
Observable.prototype.addEventListener=function(eventType,fn){if(!this.subscribers[eventType]){this.subscribers[eventType]=[];}
this.subscribers[eventType].push(fn);return new Subscription(this,eventType,fn);};Observable.prototype.removeEventListener=function(eventType,fn){var subscribers=this.subscribers[eventType];for(var i=0;i<subscribers.length;i++){if(subscribers[i]==fn){this.subscribers[eventType].splice(i,1);return true;}}
return false;};Observable.prototype.triggerEvent=function(eventType){if(!this.subscribers[eventType]){return;}
var subscribers=this.subscribers[eventType].slice(0);for(var i=0;i<subscribers.length;i++){subscribers[i].apply(null,arguments);}};function NullFilter(){}
NullFilter.prototype.match=function(o){return true;};NullFilter.prototype.makeFit=function(o){};NullFilter.prototype.makeNotFit=function(o){};NullFilter.prototype.toUniqueString=function(){return"NULL";};NullFilter.prototype.subscribeGlobally=function(){};NullFilter.prototype.unsubscribeGlobally=function(){};function AndFilter(left,right){this.left=left;this.right=right;}
AndFilter.prototype.match=function(o){return this.left.match(o)&&this.right.match(o);};AndFilter.prototype.makeFit=function(o){this.left.makeFit(o);this.right.makeFit(o);};AndFilter.prototype.makeNotFit=function(o){this.left.makeNotFit(o);this.right.makeNotFit(o);};AndFilter.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString();};AndFilter.prototype.subscribeGlobally=function(coll,entityName){this.left.subscribeGlobally(coll,entityName);this.right.subscribeGlobally(coll,entityName);};AndFilter.prototype.unsubscribeGlobally=function(coll,entityName){this.left.unsubscribeGlobally(coll,entityName);this.right.unsubscribeGlobally(coll,entityName);};function OrFilter(left,right){this.left=left;this.right=right;}
OrFilter.prototype.match=function(o){return this.left.match(o)||this.right.match(o);};OrFilter.prototype.makeFit=function(o){this.left.makeFit(o);this.right.makeFit(o);};OrFilter.prototype.makeNotFit=function(o){this.left.makeNotFit(o);this.right.makeNotFit(o);};OrFilter.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString();};OrFilter.prototype.subscribeGlobally=function(coll,entityName){this.left.subscribeGlobally(coll,entityName);this.right.subscribeGlobally(coll,entityName);};OrFilter.prototype.unsubscribeGlobally=function(coll,entityName){this.left.unsubscribeGlobally(coll,entityName);this.right.unsubscribeGlobally(coll,entityName);};function PropertyFilter(property,operator,value){this.property=property;this.operator=operator.toLowerCase();this.value=value;}
PropertyFilter.prototype.match=function(o){var value=this.value;var propValue=persistence.get(o,this.property);if(value&&value.getTime){value=Math.round(value.getTime()/1000)*1000;if(propValue&&propValue.getTime){propValue=Math.round(propValue.getTime()/1000)*1000;}}
switch(this.operator){case'=':return propValue===value;break;case'!=':return propValue!==value;break;case'<':return propValue<value;break;case'<=':return propValue<=value;break;case'>':return propValue>value;break;case'>=':return propValue>=value;break;case'in':return arrayContains(value,propValue);break;case'not in':return!arrayContains(value,propValue);break;}};PropertyFilter.prototype.makeFit=function(o){if(this.operator==='='){persistence.set(o,this.property,this.value);}else{throw new Error("Sorry, can't perform makeFit for other filters than =");}};PropertyFilter.prototype.makeNotFit=function(o){if(this.operator==='='){persistence.set(o,this.property,null);}else{throw new Error("Sorry, can't perform makeNotFit for other filters than =");}};PropertyFilter.prototype.subscribeGlobally=function(coll,entityName){persistence.subscribeToGlobalPropertyListener(coll,entityName,this.property);};PropertyFilter.prototype.unsubscribeGlobally=function(coll,entityName){persistence.unsubscribeFromGlobalPropertyListener(coll,entityName,this.property);};PropertyFilter.prototype.toUniqueString=function(){var val=this.value;if(val&&val._type){val=val.id;}
return this.property+this.operator+val;};persistence.NullFilter=NullFilter;persistence.AndFilter=AndFilter;persistence.OrFilter=OrFilter;persistence.PropertyFilter=PropertyFilter;persistence.uniqueQueryCollection=function(coll){var entityName=coll._entityName;if(coll._items){return coll;}
if(!this.queryCollectionCache[entityName]){this.queryCollectionCache[entityName]={};}
var uniqueString=coll.toUniqueString();if(!this.queryCollectionCache[entityName][uniqueString]){this.queryCollectionCache[entityName][uniqueString]=coll;}
return this.queryCollectionCache[entityName][uniqueString];}
function QueryCollection(){}
QueryCollection.prototype=new Observable();QueryCollection.prototype.oldAddEventListener=QueryCollection.prototype.addEventListener;QueryCollection.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName);};QueryCollection.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName);};QueryCollection.prototype.addEventListener=function(eventType,fn){var that=this;var subscription=this.oldAddEventListener(eventType,fn);if(this.subscribers[eventType].length===1){this.setupSubscriptions();}
subscription.oldUnsubscribe=subscription.unsubscribe;subscription.unsubscribe=function(){this.oldUnsubscribe();if(that.subscribers[eventType].length===0){that.teardownSubscriptions();}};return subscription;};QueryCollection.prototype.persistQueries=function(){return[];};QueryCollection.prototype.init=function(session,entityName,constructor){this._filter=new NullFilter();this._orderColumns=[];this._prefetchFields=[];this._entityName=entityName;this._constructor=constructor;this._limit=-1;this._skip=0;this._reverse=false;this._session=session||persistence;this.subscribers={};}
QueryCollection.prototype.toUniqueString=function(){var s=this._constructor.name+": "+this._entityName;s+='|Filter:';var values=[];s+=this._filter.toUniqueString();s+='|Values:';for(var i=0;i<values.length;i++){s+=values+"|^|";}
s+='|Order:';for(var i=0;i<this._orderColumns.length;i++){var col=this._orderColumns[i];s+=col[0]+", "+col[1];}
s+='|Prefetch:';for(var i=0;i<this._prefetchFields.length;i++){s+=this._prefetchFields[i];}
s+='|Limit:';s+=this._limit;s+='|Skip:';s+=this._skip;s+='|Reverse:';s+=this._reverse;return s;};QueryCollection.prototype.clone=function(cloneSubscribers){var c=new(this._constructor)(this._session,this._entityName);c._filter=this._filter;c._prefetchFields=this._prefetchFields.slice(0);c._orderColumns=this._orderColumns.slice(0);c._limit=this._limit;c._skip=this._skip;c._reverse=this._reverse;if(cloneSubscribers){var subscribers={};for(var eventType in this.subscribers){if(this.subscribers.hasOwnProperty(eventType)){subscribers[eventType]=this.subscribers[eventType].slice(0);}}
c.subscribers=subscribers;}else{c.subscribers=this.subscribers;}
return c;};QueryCollection.prototype.filter=function(property,operator,value){var c=this.clone(true);c._filter=new AndFilter(this._filter,new PropertyFilter(property,operator,value));var session=this._session;c=session.uniqueQueryCollection(c);return session.uniqueQueryCollection(c);};QueryCollection.prototype.or=function(filter){var c=this.clone(true);c._filter=new OrFilter(this._filter,filter);return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.and=function(filter){var c=this.clone(true);c._filter=new AndFilter(this._filter,filter);return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.order=function(property,ascending){ascending=ascending===undefined?true:ascending;var c=this.clone();c._orderColumns.push([property,ascending]);return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.limit=function(n){var c=this.clone();c._limit=n;return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.skip=function(n){var c=this.clone();c._skip=n;return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.reverse=function(){var c=this.clone();c._reverse=true;return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.prefetch=function(rel){var c=this.clone();c._prefetchFields.push(rel);return this._session.uniqueQueryCollection(c);};QueryCollection.prototype.selectJSON=function(tx,props,callback){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"props",optional:false},{name:"callback",optional:false}]);var session=this._session;var that=this;tx=args.tx;props=args.props;callback=args.callback;if(!tx){session.transaction(function(tx){that.selectJSON(tx,props,callback);});return;}
var Entity=getEntity(this._entityName);this.list(function(items){var resultArray=[];persistence.asyncForEach(items,function(item,callback){item.selectJSON(tx,props,function(obj){resultArray.push(obj);callback();});},function(){callback(resultArray);});});};QueryCollection.prototype.add=function(obj){if(!obj.id||!obj._type){throw new Error("Cannot add object of non-entity type onto collection.");}
this._session.add(obj);this._filter.makeFit(obj);this.triggerEvent('add',this,obj);this.triggerEvent('change',this,obj);}
QueryCollection.prototype.addAll=function(objs){for(var i=0;i<objs.length;i++){var obj=objs[i];this._session.add(obj);this._filter.makeFit(obj);this.triggerEvent('add',this,obj);}
this.triggerEvent('change',this);}
QueryCollection.prototype.remove=function(obj){if(!obj.id||!obj._type){throw new Error("Cannot remove object of non-entity type from collection.");}
this._filter.makeNotFit(obj);this.triggerEvent('remove',this,obj);this.triggerEvent('change',this,obj);}
function DbQueryCollection(session,entityName){this.init(session,entityName,DbQueryCollection);}
QueryCollection.prototype.each=function(tx,eachFn){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'eachFn',optional:true,check:argspec.isCallback()}]);tx=args.tx;eachFn=args.eachFn;this.list(tx,function(results){for(var i=0;i<results.length;i++){eachFn(results[i]);}});}
QueryCollection.prototype.forEach=QueryCollection.prototype.each;QueryCollection.prototype.one=function(tx,oneFn){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'oneFn',optional:false,check:argspec.isCallback()}]);tx=args.tx;oneFn=args.oneFn;var that=this;this.limit(1).list(tx,function(results){if(results.length===0){oneFn(null);}else{oneFn(results[0]);}});}
DbQueryCollection.prototype=new QueryCollection();function AllDbQueryCollection(session,entityName){this.init(session,entityName,AllDbQueryCollection);}
AllDbQueryCollection.prototype=new DbQueryCollection();AllDbQueryCollection.prototype.add=function(obj){this._session.add(obj);this.triggerEvent('add',this,obj);this.triggerEvent('change',this,obj);};AllDbQueryCollection.prototype.remove=function(obj){this._session.remove(obj);this.triggerEvent('remove',this,obj);this.triggerEvent('change',this,obj);};function ManyToManyDbQueryCollection(session,entityName){this.init(session,entityName,persistence.ManyToManyDbQueryCollection);this._localAdded=[];this._localRemoved=[];}
ManyToManyDbQueryCollection.prototype=new DbQueryCollection();ManyToManyDbQueryCollection.prototype.initManyToMany=function(obj,coll){this._obj=obj;this._coll=coll;};ManyToManyDbQueryCollection.prototype.add=function(obj){if(!arrayContains(this._localAdded,obj)){this._session.add(obj);this._localAdded.push(obj);this.triggerEvent('add',this,obj);this.triggerEvent('change',this,obj);}};ManyToManyDbQueryCollection.prototype.addAll=function(objs){for(var i=0;i<objs.length;i++){var obj=objs[i];if(!arrayContains(this._localAdded,obj)){this._session.add(obj);this._localAdded.push(obj);this.triggerEvent('add',this,obj);}}
this.triggerEvent('change',this);}
ManyToManyDbQueryCollection.prototype.clone=function(){var c=DbQueryCollection.prototype.clone.call(this);c._localAdded=this._localAdded;c._localRemoved=this._localRemoved;c._obj=this._obj;c._coll=this._coll;return c;};ManyToManyDbQueryCollection.prototype.remove=function(obj){if(arrayContains(this._localAdded,obj)){arrayRemove(this._localAdded,obj);}else if(!arrayContains(this._localRemoved,obj)){this._localRemoved.push(obj);}
this.triggerEvent('remove',this,obj);this.triggerEvent('change',this,obj);};function LocalQueryCollection(initialArray){this.init(persistence,null,LocalQueryCollection);this._items=initialArray||[];}
LocalQueryCollection.prototype=new QueryCollection();LocalQueryCollection.prototype.clone=function(){var c=DbQueryCollection.prototype.clone.call(this);c._items=this._items;return c;};LocalQueryCollection.prototype.add=function(obj){if(!arrayContains(this._items,obj)){this._session.add(obj);this._items.push(obj);this.triggerEvent('add',this,obj);this.triggerEvent('change',this,obj);}};LocalQueryCollection.prototype.addAll=function(objs){for(var i=0;i<objs.length;i++){var obj=objs[i];if(!arrayContains(this._items,obj)){this._session.add(obj);this._items.push(obj);this.triggerEvent('add',this,obj);}}
this.triggerEvent('change',this);}
LocalQueryCollection.prototype.remove=function(obj){var items=this._items;for(var i=0;i<items.length;i++){if(items[i]===obj){this._items.splice(i,1);this.triggerEvent('remove',this,obj);this.triggerEvent('change',this,obj);}}};LocalQueryCollection.prototype.list=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:true,check:argspec.isCallback()}]);callback=args.callback;if(!callback||callback.executeSql){callback=arguments[1];}
var array=this._items.slice(0);var that=this;var results=[];for(var i=0;i<array.length;i++){if(this._filter.match(array[i])){results.push(array[i]);}}
results.sort(function(a,b){for(var i=0;i<that._orderColumns.length;i++){var col=that._orderColumns[i][0];var asc=that._orderColumns[i][1];var aVal=persistence.get(a,col);var bVal=persistence.get(b,col);if(aVal<bVal){return asc?-1:1;}else if(aVal>bVal){return asc?1:-1;}}
return 0;});if(this._skip){results.splice(0,this._skip);}
if(this._limit>-1){results=results.slice(0,this._limit);}
if(this._reverse){results.reverse();}
if(callback){callback(results);}else{return results;}};LocalQueryCollection.prototype.destroyAll=function(callback){if(!callback||callback.executeSql){callback=arguments[1];}
this._items=[];this.triggerEvent('change',this);if(callback)callback();};LocalQueryCollection.prototype.count=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:true,check:argspec.isCallback()}]);tx=args.tx;callback=args.callback;var result=this.list();if(callback){callback(result.length);}else{return result.length;}};persistence.QueryCollection=QueryCollection;persistence.DbQueryCollection=DbQueryCollection;persistence.ManyToManyDbQueryCollection=ManyToManyDbQueryCollection;persistence.LocalQueryCollection=LocalQueryCollection;persistence.Observable=Observable;persistence.Subscription=Subscription;persistence.AndFilter=AndFilter;persistence.OrFilter=OrFilter;persistence.PropertyFilter=PropertyFilter;}());var argspec={};(function(){argspec.getArgs=function(args,specs){var argIdx=0;var specIdx=0;var argObj={};while(specIdx<specs.length){var s=specs[specIdx];var a=args[argIdx];if(s.optional){if(a!==undefined&&s.check(a)){argObj[s.name]=a;argIdx++;specIdx++;}else{if(s.defaultValue!==undefined){argObj[s.name]=s.defaultValue;}
specIdx++;}}else{if(s.check&&!s.check(a)){throw new Error("Invalid value for argument: "+s.name+" Value: "+a);}
argObj[s.name]=a;specIdx++;argIdx++;}}
return argObj;}
argspec.hasProperty=function(name){return function(obj){return obj&&obj[name]!==undefined;};}
argspec.hasType=function(type){return function(obj){return typeof obj===type;};}
argspec.isCallback=function(){return function(obj){return obj&&obj.apply;};}}());persistence.argspec=argspec;return persistence;}
if(typeof JSON==='undefined'){JSON={};}
if(!JSON.stringify){(function(){function f(n){return n<10?'0'+n:n;}
if(typeof Date.prototype.toJSON!=='function'){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+'-'+
f(this.getUTCMonth()+1)+'-'+
f(this.getUTCDate())+'T'+
f(this.getUTCHours())+':'+
f(this.getUTCMinutes())+':'+
f(this.getUTCSeconds())+'Z':null;};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf();};}
var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==='string'?c:'\\u'+('0000'+a.charCodeAt(0).toString(16)).slice(-4);})+'"':'"'+string+'"';}
function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==='object'&&typeof value.toJSON==='function'){value=value.toJSON(key);}
if(typeof rep==='function'){value=rep.call(holder,key,value);}
switch(typeof value){case'string':return quote(value);case'number':return isFinite(value)?String(value):'null';case'boolean':case'null':return String(value);case'object':if(!value){return'null';}
gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==='[object Array]'){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||'null';}
v=partial.length===0?'[]':gap?'[\n'+gap+
partial.join(',\n'+gap)+'\n'+
mind+']':'['+partial.join(',')+']';gap=mind;return v;}
if(rep&&typeof rep==='object'){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==='string'){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?': ':':')+v);}}}}
v=partial.length===0?'{}':gap?'{\n'+gap+partial.join(',\n'+gap)+'\n'+
mind+'}':'{'+partial.join(',')+'}';gap=mind;return v;}}
if(typeof JSON.stringify!=='function'){JSON.stringify=function(value,replacer,space){var i;gap='';indent='';if(typeof space==='number'){for(i=0;i<space;i+=1){indent+=' ';}}else if(typeof space==='string'){indent=space;}
rep=replacer;if(replacer&&typeof replacer!=='function'&&(typeof replacer!=='object'||typeof replacer.length!=='number')){throw new Error('JSON.stringify');}
return str('',{'':value});};}
if(typeof JSON.parse!=='function'){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==='object'){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v;}else{delete value[k];}}}}
return reviver.call(holder,key,value);}
cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return'\\u'+
('0000'+a.charCodeAt(0).toString(16)).slice(-4);});}
if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,'@').replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,']').replace(/(?:^|:|,)(?:\s*\[)+/g,''))){j=eval('('+text+')');return typeof reviver==='function'?walk({'':j},''):j;}
throw new SyntaxError('JSON.parse');};}}());}
try{if(!window){window={};}}catch(e){window={};exports.console=console;}
var persistence=(window&&window.persistence)?window.persistence:{};if(!persistence.store){persistence.store={};}
persistence.store.memory={};persistence.store.memory.config=function(persistence,dbname){var argspec=persistence.argspec;dbname=dbname||'persistenceData';var allObjects={};persistence.getAllObjects=function(){return allObjects;};var defaultAdd=persistence.add;persistence.add=function(obj){if(!this.trackedObjects[obj.id]){defaultAdd.call(this,obj);var entityName=obj._type;if(!allObjects[entityName]){allObjects[entityName]=new persistence.LocalQueryCollection();allObjects[entityName]._session=persistence;}
allObjects[entityName].add(obj);}
return this;};var defaultRemove=persistence.remove;persistence.remove=function(obj){defaultRemove.call(this,obj);var entityName=obj._type;allObjects[entityName].remove(obj);};persistence.schemaSync=function(tx,callback,emulate){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}},{name:"emulate",optional:true,check:argspec.hasType('boolean')}]);args.callback();};persistence.flush=function(tx,callback){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);var fns=persistence.flushHooks;persistence.asyncForEach(fns,function(fn,callback){fn(session,tx,callback);},function(){var trackedObjects=persistence.trackedObjects;for(var id in trackedObjects){if(trackedObjects.hasOwnProperty(id)){if(persistence.objectsToRemove.hasOwnProperty(id)){delete trackedObjects[id];}else{trackedObjects[id]._dirtyProperties={};}}}
args.callback();});};persistence.transaction=function(callback){setTimeout(function(){callback({executeSql:function(){}});},0);};persistence.loadFromLocalStorage=function(callback){var dump=window.localStorage.getItem(dbname);if(dump){this.loadFromJson(dump,callback);}else{callback&&callback();}};persistence.saveToLocalStorage=function(callback){this.dumpToJson(function(dump){window.localStorage.setItem(dbname,dump);if(callback){callback();}});};persistence.reset=function(tx,callback){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;callback=args.callback;allObjects={};this.clean();callback();};persistence.close=function(){};function makeLocalClone(otherColl){var coll=allObjects[otherColl._entityName];if(!coll){coll=new persistence.LocalQueryCollection();}
coll=coll.clone();coll._filter=otherColl._filter;coll._prefetchFields=otherColl._prefetchFields;coll._orderColumns=otherColl._orderColumns;coll._limit=otherColl._limit;coll._skip=otherColl._skip;coll._reverse=otherColl._reverse;return coll;}
persistence.DbQueryCollection.prototype.list=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:false,check:argspec.isCallback()}]);tx=args.tx;callback=args.callback;var coll=makeLocalClone(this);coll.list(null,callback);};persistence.DbQueryCollection.prototype.destroyAll=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;callback=args.callback;var coll=makeLocalClone(this);coll.destroyAll(null,callback);};persistence.DbQueryCollection.prototype.count=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:false,check:argspec.isCallback()}]);tx=args.tx;callback=args.callback;var coll=makeLocalClone(this);coll.count(null,callback);};persistence.ManyToManyDbQueryCollection=function(session,entityName){this.init(session,entityName,persistence.ManyToManyDbQueryCollection);this._items=[];};persistence.ManyToManyDbQueryCollection.prototype=new persistence.LocalQueryCollection();persistence.ManyToManyDbQueryCollection.prototype.initManyToMany=function(obj,coll){this._obj=obj;this._coll=coll;};persistence.ManyToManyDbQueryCollection.prototype.add=function(item,recursing){persistence.LocalQueryCollection.prototype.add.call(this,item);if(!recursing){var meta=persistence.getMeta(this._obj._type);var inverseProperty=meta.hasMany[this._coll].inverseProperty;persistence.get(item,inverseProperty).add(this._obj,true);}};persistence.ManyToManyDbQueryCollection.prototype.remove=function(item,recursing){persistence.LocalQueryCollection.prototype.remove.call(this,item);if(!recursing){var meta=persistence.getMeta(this._obj._type);var inverseProperty=meta.hasMany[this._coll].inverseProperty;persistence.get(item,inverseProperty).remove(this._obj,true);}};};try{exports.config=persistence.store.memory.config;exports.getSession=function(){return persistence;};}catch(e){}
var defaultTypeMapper={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(type){switch(type){case'JSON':return'TEXT';case'BOOL':return'INT';case'DATE':return'INT';default:return type;}},inVar:function(str,type){return str;},outVar:function(str,type){return str;},outId:function(str){return"'"+str+"'";},dbValToEntityVal:function(val,type){if(val===null||val===undefined){return val;}
switch(type){case'DATE':return new Date(parseInt(val,10)*1000);case'BOOL':return val===1||val==='1';break;case'INT':return+val;break;case'BIGINT':return+val;break;case'JSON':if(val){return JSON.parse(val);}
else{return val;}
break;default:return val;}},entityValToDbVal:function(val,type){if(val===undefined||val===null){return null;}
else if(type==='JSON'&&val){return JSON.stringify(val);}
else if(val.id){return val.id;}
else if(type==='BOOL'){return(val==='false')?0:(val?1:0);}
else if(type==='DATE'||val.getTime){val=new Date(val);return Math.round(val.getTime()/1000);}
else{return val;}},inIdVar:function(str){return this.inVar(str,this.idType);},outIdVar:function(str){return this.outVar(str,this.idType);},entityIdToDbId:function(id){return this.entityValToDbVal(id,this.idType);}}
function config(persistence,dialect){var argspec=persistence.argspec;persistence.typeMapper=dialect.typeMapper||defaultTypeMapper;persistence.generatedTables={};persistence.schemaSync=function(tx,callback,emulate){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}},{name:"emulate",optional:true,check:argspec.hasType('boolean')}]);tx=args.tx;callback=args.callback;emulate=args.emulate;if(!tx){var session=this;this.transaction(function(tx){session.schemaSync(tx,callback,emulate);});return;}
var queries=[],meta,colDefs,otherMeta,tableName;var tm=persistence.typeMapper;var entityMeta=persistence.getEntityMeta();for(var entityName in entityMeta){if(entityMeta.hasOwnProperty(entityName)){meta=entityMeta[entityName];if(!meta.isMixin){colDefs=[];for(var prop in meta.fields){if(meta.fields.hasOwnProperty(prop)){colDefs.push([prop,meta.fields[prop]]);}}
for(var rel in meta.hasOne){if(meta.hasOne.hasOwnProperty(rel)){otherMeta=meta.hasOne[rel].type.meta;colDefs.push([rel,tm.idType]);queries.push([dialect.createIndex(meta.name,[rel]),null]);}}
for(var i=0;i<meta.indexes.length;i++){queries.push([dialect.createIndex(meta.name,meta.indexes[i].columns,meta.indexes[i]),null]);}}
for(var rel in meta.hasMany){if(meta.hasMany.hasOwnProperty(rel)&&meta.hasMany[rel].manyToMany){tableName=meta.hasMany[rel].tableName;if(!persistence.generatedTables[tableName]){var otherMeta=meta.hasMany[rel].type.meta;var inv=meta.hasMany[rel].inverseProperty;if(otherMeta.hasMany[inv].type.meta!=meta)
continue;var p1=meta.name+"_"+rel;var p2=otherMeta.name+"_"+inv;queries.push([dialect.createIndex(tableName,[p1]),null]);queries.push([dialect.createIndex(tableName,[p2]),null]);var columns=[[p1,tm.idType],[p2,tm.idType]];if(meta.isMixin)
columns.push([p1+"_class",tm.classNameType])
if(otherMeta.isMixin)
columns.push([p2+"_class",tm.classNameType])
queries.push([dialect.createTable(tableName,columns),null]);persistence.generatedTables[tableName]=true;}}}
if(!meta.isMixin){colDefs.push(["id",tm.idType,"PRIMARY KEY"]);persistence.generatedTables[meta.name]=true;queries.push([dialect.createTable(meta.name,colDefs),null]);}}}
var fns=persistence.schemaSyncHooks;for(var i=0;i<fns.length;i++){fns[i](tx);}
if(emulate){callback(tx);}else{executeQueriesSeq(tx,queries,function(_,err){callback(tx,err);});}};persistence.flush=function(tx,callback){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:null}]);tx=args.tx;callback=args.callback;var session=this;if(!tx){this.transaction(function(tx){session.flush(tx,callback);});return;}
var fns=persistence.flushHooks;persistence.asyncForEach(fns,function(fn,callback){fn(session,tx,callback);},function(){var persistObjArray=[];for(var id in session.trackedObjects){if(session.trackedObjects.hasOwnProperty(id)){persistObjArray.push(session.trackedObjects[id]);}}
var removeObjArray=[];for(var id in session.objectsToRemove){if(session.objectsToRemove.hasOwnProperty(id)){removeObjArray.push(session.objectsToRemove[id]);delete session.trackedObjects[id];}}
session.objectsToRemove={};if(callback){persistence.asyncParForEach(removeObjArray,function(obj,callback){remove(obj,tx,callback);},function(result,err){if(err)return callback(result,err);persistence.asyncParForEach(persistObjArray,function(obj,callback){save(obj,tx,callback);},callback);});}else{for(var i=0;i<persistObjArray.length;i++){save(persistObjArray[i],tx);}
for(var i=0;i<removeObjArray.length;i++){remove(removeObjArray[i],tx);}}});};persistence.reset=function(tx,callback){var args=argspec.getArgs(arguments,[{name:"tx",optional:true,check:persistence.isTransaction,defaultValue:null},{name:"callback",optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;callback=args.callback;var session=this;if(!tx){session.transaction(function(tx){session.reset(tx,callback);});return;}
this.schemaSync(tx,function(){var tableArray=[];for(var p in persistence.generatedTables){if(persistence.generatedTables.hasOwnProperty(p)){tableArray.push(p);}}
function dropOneTable(){var tableName=tableArray.pop();tx.executeSql("DROP TABLE IF EXISTS `"+tableName+"`",null,function(){if(tableArray.length>0){dropOneTable();}else{cb();}},cb);}
if(tableArray.length>0){dropOneTable();}else{cb();}
function cb(result,err){session.clean();persistence.generatedTables={};if(callback)callback(result,err);}},true);};function rowToEntity(session,entityName,row,prefix){prefix=prefix||'';if(session.trackedObjects[row[prefix+"id"]]){return session.trackedObjects[row[prefix+"id"]];}
var tm=persistence.typeMapper;var rowMeta=persistence.getMeta(entityName);var ent=persistence.define(entityName);if(!row[prefix+'id']){return null;}
var o=new ent(session,undefined,true);o.id=tm.dbValToEntityVal(row[prefix+'id'],tm.idType);o._new=false;for(var p in row){if(row.hasOwnProperty(p)){if(p.substring(0,prefix.length)===prefix){var prop=p.substring(prefix.length);if(prop!='id'){o._data[prop]=tm.dbValToEntityVal(row[p],rowMeta.fields[prop]||tm.idType);}}}}
return o;}
function save(obj,tx,callback){var meta=persistence.getMeta(obj._type);var tm=persistence.typeMapper;var properties=[];var values=[];var qs=[];var propertyPairs=[];if(obj._new){for(var p in meta.fields){if(meta.fields.hasOwnProperty(p)){obj._dirtyProperties[p]=true;}}}
for(var p in obj._dirtyProperties){if(obj._dirtyProperties.hasOwnProperty(p)){properties.push("`"+p+"`");var type=meta.fields[p]||tm.idType;values.push(tm.entityValToDbVal(obj._data[p],type));qs.push(tm.outVar("?",type));propertyPairs.push("`"+p+"` = "+tm.outVar("?",type));}}
var additionalQueries=[];for(var p in meta.hasMany){if(meta.hasMany.hasOwnProperty(p)){additionalQueries=additionalQueries.concat(persistence.get(obj,p).persistQueries());}}
executeQueriesSeq(tx,additionalQueries,function(){if(properties.length===0){if(callback)callback();return;}
obj._dirtyProperties={};if(obj._new){properties.push('id');values.push(tm.entityIdToDbId(obj.id));qs.push(tm.outIdVar('?'));var sql="INSERT INTO `"+obj._type+"` ("+properties.join(", ")+") VALUES ("+qs.join(', ')+")";obj._new=false;tx.executeSql(sql,values,callback,callback);}else{var sql="UPDATE `"+obj._type+"` SET "+propertyPairs.join(',')+" WHERE id = "+tm.outId(obj.id);tx.executeSql(sql,values,callback,callback);}});}
persistence.save=save;function remove(obj,tx,callback){var meta=persistence.getMeta(obj._type);var tm=persistence.typeMapper;var queries=[["DELETE FROM `"+obj._type+"` WHERE id = "+tm.outId(obj.id),null]];for(var rel in meta.hasMany){if(meta.hasMany.hasOwnProperty(rel)&&meta.hasMany[rel].manyToMany){var tableName=meta.hasMany[rel].tableName;queries.push(["DELETE FROM `"+tableName+"` WHERE `"+meta.name+'_'+rel+"` = "+tm.outId(obj.id),null]);}}
executeQueriesSeq(tx,queries,callback);}
function executeQueriesSeq(tx,queries,callback){var callbackArgs=[];for(var i=3;i<arguments.length;i++){callbackArgs.push(arguments[i]);}
persistence.asyncForEach(queries,function(queryTuple,callback){tx.executeSql(queryTuple[0],queryTuple[1],callback,function(_,err){console.log(err.message);callback(_,err);});},function(result,err){if(err&&callback){callback(result,err);return;}
if(callback)callback.apply(null,callbackArgs);});}
persistence.executeQueriesSeq=executeQueriesSeq;persistence.QueryCollection.prototype.persistQueries=function(){return[];};var oldQCClone=persistence.QueryCollection.prototype.clone;persistence.QueryCollection.prototype.clone=function(cloneSubscribers){var c=oldQCClone.call(this,cloneSubscribers);c._additionalJoinSqls=this._additionalJoinSqls.slice(0);c._additionalWhereSqls=this._additionalWhereSqls.slice(0);c._additionalGroupSqls=this._additionalGroupSqls.slice(0);c._manyToManyFetch=this._manyToManyFetch;return c;};var oldQCInit=persistence.QueryCollection.prototype.init;persistence.QueryCollection.prototype.init=function(session,entityName,constructor){oldQCInit.call(this,session,entityName,constructor);this._manyToManyFetch=null;this._additionalJoinSqls=[];this._additionalWhereSqls=[];this._additionalGroupSqls=[];};var oldQCToUniqueString=persistence.QueryCollection.prototype.toUniqueString;persistence.QueryCollection.prototype.toUniqueString=function(){var s=oldQCToUniqueString.call(this);s+='|JoinSQLs:';for(var i=0;i<this._additionalJoinSqls.length;i++){s+=this._additionalJoinSqls[i];}
s+='|WhereSQLs:';for(var i=0;i<this._additionalWhereSqls.length;i++){s+=this._additionalWhereSqls[i];}
s+='|GroupSQLs:';for(var i=0;i<this._additionalGroupSqls.length;i++){s+=this._additionalGroupSqls[i];}
if(this._manyToManyFetch){s+='|ManyToManyFetch:';s+=JSON.stringify(this._manyToManyFetch);}
return s;};persistence.NullFilter.prototype.sql=function(meta,alias,values){return"1=1";};persistence.AndFilter.prototype.sql=function(meta,alias,values){return"("+this.left.sql(meta,alias,values)+" AND "
+this.right.sql(meta,alias,values)+")";};persistence.OrFilter.prototype.sql=function(meta,alias,values){return"("+this.left.sql(meta,alias,values)+" OR "
+this.right.sql(meta,alias,values)+")";};persistence.PropertyFilter.prototype.sql=function(meta,alias,values){var tm=persistence.typeMapper;var aliasPrefix=alias?"`"+alias+"`.":"";var sqlType=meta.fields[this.property]||tm.idType;if(this.operator==='='&&this.value===null){return aliasPrefix+'`'+this.property+"` IS NULL";}else if(this.operator==='!='&&this.value===null){return aliasPrefix+'`'+this.property+"` IS NOT NULL";}else if(this.operator==='in'){var vals=this.value;var qs=[];for(var i=0;i<vals.length;i++){qs.push('?');values.push(tm.entityValToDbVal(vals[i],sqlType));}
if(vals.length===0){return"1 = 0";}else{return aliasPrefix+'`'+this.property+"` IN ("+qs.join(', ')+")";}}else if(this.operator==='not in'){var vals=this.value;var qs=[];for(var i=0;i<vals.length;i++){qs.push('?');values.push(tm.entityValToDbVal(vals[i],sqlType));}
if(vals.length===0){return"1 = 1";}else{return aliasPrefix+'`'+this.property+"` NOT IN ("+qs.join(', ')+")";}}else{var value=this.value;if(value===true||value===false){value=value?1:0;}
values.push(tm.entityValToDbVal(value,sqlType));return aliasPrefix+'`'+this.property+"` "+this.operator+" "+tm.outVar("?",sqlType);}};persistence.DbQueryCollection.prototype.list=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:false,check:argspec.isCallback()}]);tx=args.tx;callback=args.callback;var that=this;var session=this._session;if(!tx){session.transaction(function(tx){that.list(tx,callback);});return;}
var entityName=this._entityName;var meta=persistence.getMeta(entityName);var tm=persistence.typeMapper;if(meta.isMixin){var result=[];persistence.asyncForEach(meta.mixedIns,function(realMeta,next){var query=that.clone();query._entityName=realMeta.name;query.list(tx,function(array){result=result.concat(array);next();});},function(){var query=new persistence.LocalQueryCollection(result);query._orderColumns=that._orderColumns;query._reverse=that._reverse;query.list(null,callback);});return;}
function selectAll(meta,tableAlias,prefix){var selectFields=[tm.inIdVar("`"+tableAlias+"`.id")+" AS "+prefix+"id"];for(var p in meta.fields){if(meta.fields.hasOwnProperty(p)){selectFields.push(tm.inVar("`"+tableAlias+"`.`"+p+"`",meta.fields[p])+" AS `"
+prefix+p+"`");}}
for(var p in meta.hasOne){if(meta.hasOne.hasOwnProperty(p)){selectFields.push(tm.inIdVar("`"+tableAlias+"`.`"+p+"`")+" AS `"
+prefix+p+"`");}}
return selectFields;}
var args=[];var mainPrefix=entityName+"_";var mainAlias='root';var selectFields=selectAll(meta,mainAlias,mainPrefix);var joinSql='';var additionalWhereSqls=this._additionalWhereSqls.slice(0);var mtm=this._manyToManyFetch;if(mtm){joinSql+="LEFT JOIN `"+mtm.table+"` AS mtm ON mtm.`"+mtm.inverseProp+"` = `root`.`id` ";additionalWhereSqls.push("mtm.`"+mtm.prop+"` = "+tm.outId(mtm.id));}
joinSql+=this._additionalJoinSqls.join(' ');for(var i=0;i<this._prefetchFields.length;i++){var prefetchField=this._prefetchFields[i];var thisMeta=meta.hasOne[prefetchField].type.meta;if(thisMeta.isMixin)
throw new Error("cannot prefetch a mixin");var tableAlias=thisMeta.name+'_'+prefetchField+"_tbl";selectFields=selectFields.concat(selectAll(thisMeta,tableAlias,prefetchField+"_"));joinSql+="LEFT JOIN `"+thisMeta.name+"` AS `"+tableAlias
+"` ON `"+tableAlias+"`.`id` = `"+mainAlias+'`.`'+prefetchField+"` ";}
var whereSql="WHERE "
+[this._filter.sql(meta,mainAlias,args)].concat(additionalWhereSqls).join(' AND ');var sql="SELECT "+selectFields.join(", ")+" FROM `"+entityName
+"` AS `"+mainAlias+"` "+joinSql+" "+whereSql;if(this._additionalGroupSqls.length>0){sql+=this._additionalGroupSqls.join(' ');}
if(this._orderColumns.length>0){sql+=" ORDER BY "
+this._orderColumns.map(function(c){return"`"+mainPrefix+c[0]+"` "
+(c[1]?"ASC":"DESC");}).join(", ");}
if(this._limit>=0){sql+=" LIMIT "+this._limit;}
if(this._skip>0){sql+=" OFFSET "+this._skip;}
session.flush(tx,function(){tx.executeSql(sql,args,function(rows){var results=[];if(that._reverse){rows.reverse();}
for(var i=0;i<rows.length;i++){var r=rows[i];var e=rowToEntity(session,entityName,r,mainPrefix);for(var j=0;j<that._prefetchFields.length;j++){var prefetchField=that._prefetchFields[j];var thisMeta=meta.hasOne[prefetchField].type.meta;e._data_obj[prefetchField]=rowToEntity(session,thisMeta.name,r,prefetchField+'_');session.add(e._data_obj[prefetchField]);}
results.push(e);session.add(e);}
callback(results);that.triggerEvent('list',that,results);});});};persistence.DbQueryCollection.prototype.destroyAll=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:true,check:argspec.isCallback(),defaultValue:function(){}}]);tx=args.tx;callback=args.callback;var that=this;var session=this._session;if(!tx){session.transaction(function(tx){that.destroyAll(tx,callback);});return;}
var entityName=this._entityName;var meta=persistence.getMeta(entityName);var tm=persistence.typeMapper;if(meta.isMixin){persistence.asyncForEach(meta.mixedIns,function(realMeta,next){var query=that.clone();query._entityName=realMeta.name;query.destroyAll(tx,callback);},callback);return;}
var joinSql='';var additionalWhereSqls=this._additionalWhereSqls.slice(0);var mtm=this._manyToManyFetch;if(mtm){joinSql+="LEFT JOIN `"+mtm.table+"` AS mtm ON mtm.`"+mtm.inverseProp+"` = `root`.`id` ";additionalWhereSqls.push("mtm.`"+mtm.prop+"` = "+tm.outId(mtm.id));}
joinSql+=this._additionalJoinSqls.join(' ');var args=[];var whereSql="WHERE "
+[this._filter.sql(meta,null,args)].concat(additionalWhereSqls).join(' AND ');var selectSql="SELECT id FROM `"+entityName+"` "+joinSql+' '+whereSql;var deleteSql="DELETE FROM `"+entityName+"` "+joinSql+' '+whereSql;var args2=args.slice(0);session.flush(tx,function(){tx.executeSql(selectSql,args,function(results){for(var i=0;i<results.length;i++){delete session.trackedObjects[results[i].id];session.objectsRemoved.push({id:results[i].id,entity:entityName});}
that.triggerEvent('change',that);tx.executeSql(deleteSql,args2,callback,callback);},callback);});};persistence.DbQueryCollection.prototype.count=function(tx,callback){var args=argspec.getArgs(arguments,[{name:'tx',optional:true,check:persistence.isTransaction,defaultValue:null},{name:'callback',optional:false,check:argspec.isCallback()}]);tx=args.tx;callback=args.callback;var that=this;var session=this._session;if(tx&&!tx.executeSql){callback=tx;tx=null;}
if(!tx){session.transaction(function(tx){that.count(tx,callback);});return;}
var entityName=this._entityName;var meta=persistence.getMeta(entityName);var tm=persistence.typeMapper;if(meta.isMixin){var result=0;persistence.asyncForEach(meta.mixedIns,function(realMeta,next){var query=that.clone();query._entityName=realMeta.name;query.count(tx,function(count){result+=count;next();});},function(){callback(result);});return;}
var joinSql='';var additionalWhereSqls=this._additionalWhereSqls.slice(0);var mtm=this._manyToManyFetch;if(mtm){joinSql+="LEFT JOIN `"+mtm.table+"` AS mtm ON mtm.`"+mtm.inverseProp+"` = `root`.`id` ";additionalWhereSqls.push("mtm.`"+mtm.prop+"` = "+tm.outId(mtm.id));}
joinSql+=this._additionalJoinSqls.join(' ');var args=[];var whereSql="WHERE "+[this._filter.sql(meta,"root",args)].concat(additionalWhereSqls).join(' AND ');var sql="SELECT COUNT(*) AS cnt FROM `"+entityName+"` AS `root` "+joinSql+" "+whereSql;session.flush(tx,function(){tx.executeSql(sql,args,function(results){callback(parseInt(results[0].cnt,10));});});};persistence.ManyToManyDbQueryCollection.prototype.persistQueries=function(){var queries=[];var meta=persistence.getMeta(this._obj._type);var inverseMeta=meta.hasMany[this._coll].type.meta;var tm=persistence.typeMapper;var rel=meta.hasMany[this._coll];var inv=inverseMeta.hasMany[rel.inverseProperty];var direct=rel.mixin?rel.mixin.meta.name:meta.name;var inverse=inv.mixin?inv.mixin.meta.name:inverseMeta.name;for(var i=0;i<this._localAdded.length;i++){var columns=[direct+"_"+this._coll,inverse+'_'+rel.inverseProperty];var vars=[tm.outIdVar("?"),tm.outIdVar("?")];var args=[tm.entityIdToDbId(this._obj.id),tm.entityIdToDbId(this._localAdded[i].id)];if(rel.mixin){columns.push(direct+"_"+this._coll+"_class");vars.push("?");args.push(meta.name);}
if(inv.mixin){columns.push(inverse+"_"+rel.inverseProperty+"_class");vars.push("?");args.push(inverseMeta.name);}
queries.push(["INSERT INTO "+rel.tableName+" (`"+columns.join("`, `")+"`) VALUES ("+vars.join(",")+")",args]);}
this._localAdded=[];for(var i=0;i<this._localRemoved.length;i++){queries.push(["DELETE FROM  "+rel.tableName+" WHERE `"+direct+"_"+this._coll+"` = "+tm.outIdVar("?")+" AND `"+
inverse+'_'+rel.inverseProperty+"` = "+tm.outIdVar("?"),[tm.entityIdToDbId(this._obj.id),tm.entityIdToDbId(this._localRemoved[i].id)]]);}
this._localRemoved=[];return queries;};};if(typeof exports!=='undefined'){exports.defaultTypeMapper=defaultTypeMapper;exports.config=config;}
else{window=window||{};window.persistence=window.persistence||{};window.persistence.store=window.persistence.store||{};window.persistence.store.sql={defaultTypeMapper:defaultTypeMapper,config:config};}
var sys=require('sys');var sql=require('./persistence.store.sql');var sqlite=require('sqlite');var db,username,password;function log(o){sys.print(sys.inspect(o)+"\n");}
exports.config=function(persistence,dbPath){exports.getSession=function(cb){var that={};cb=cb||function(){};var conn=new sqlite.Database();conn.open(dbPath,cb);var session=new persistence.Session(that);session.transaction=function(explicitCommit,fn){if(typeof arguments[0]==="function"){fn=arguments[0];explicitCommit=false;}
var tx=transaction(conn);if(explicitCommit){tx.executeSql("START TRANSACTION",null,function(){fn(tx)});}
else
fn(tx);};session.close=function(cb){cb=cb||function(){};conn.close(cb);};return session;};function transaction(conn){var that={};that.executeSql=function(query,args,successFn,errorFn){function cb(err,result){if(err){log(err.message);that.errorHandler&&that.errorHandler(err);errorFn&&errorFn(null,err);return;}
if(successFn){successFn(result);}}
if(persistence.debug){sys.print(query+"\n");args&&args.length>0&&sys.print(args.join(",")+"\n")}
if(!args){conn.execute(query,cb);}
else{conn.execute(query,args,cb);}}
that.commit=function(session,callback){session.flush(that,function(){that.executeSql("COMMIT",null,callback);})}
that.rollback=function(session,callback){that.executeSql("ROLLBACK",null,function(){session.clean();callback();});}
return that;}
persistence.sqliteDialect={createTable:function(tableName,columns){var tm=persistence.typeMapper;var sql="CREATE TABLE IF NOT EXISTS `"+tableName+"` (";var defs=[];for(var i=0;i<columns.length;i++){var column=columns[i];defs.push("`"+column[0]+"` "+tm.columnType(column[1])+(column[2]?" "+column[2]:""));}
sql+=defs.join(", ");sql+=')';return sql;},createIndex:function(tableName,columns,options){options=options||{};return"CREATE "+(options.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+tableName+"__"+columns.join("_")+"` ON `"+tableName+"` ("+
columns.map(function(col){return"`"+col+"`";}).join(", ")+")";}};sql.config(persistence,persistence.sqliteDialect);};try{if(!window){window={};}}catch(e){window={};exports.console=console;}
var persistence=(window&&window.persistence)?window.persistence:{};if(!persistence.store){persistence.store={};}
persistence.store.websql={};persistence.store.websql.config=function(persistence,dbname,description,size){var conn=null;persistence.transaction=function(callback){if(!conn){throw new Error("No ongoing database connection, please connect first.");}else{conn.transaction(callback);}};persistence.db=persistence.db||{};persistence.db.implementation="unsupported";persistence.db.conn=null;if(window&&window.openDatabase){persistence.db.implementation="html5";}else if(window&window.google&&google.gears){persistence.db.implementation="gears";}else{try{if(openDatabaseSync){persistence.db.implementation="html5-sync";}}catch(e){}}
persistence.db.html5={};persistence.db.html5.connect=function(dbname,description,size){var that={};var conn=openDatabase(dbname,'1.0',description,size);that.transaction=function(fn){return conn.transaction(function(sqlt){return fn(persistence.db.html5.transaction(sqlt));});};return that;};persistence.db.html5.transaction=function(t){var that={};that.executeSql=function(query,args,successFn,errorFn){if(persistence.debug){console.log(query,args);}
t.executeSql(query,args,function(_,result){if(successFn){var results=[];for(var i=0;i<result.rows.length;i++){results.push(result.rows.item(i));}
successFn(results);}},errorFn);};return that;};persistence.db.html5Sync={};persistence.db.html5Sync.connect=function(dbname,description,size){var that={};var conn=openDatabaseSync(dbname,'1.0',description,size);that.transaction=function(fn){return conn.transaction(function(sqlt){return fn(persistence.db.html5Sync.transaction(sqlt));});};return that;};persistence.db.html5Sync.transaction=function(t){var that={};that.executeSql=function(query,args,successFn,errorFn){if(args==null)args=[];if(persistence.debug){console.log(query,args);}
var result=t.executeSql(query,args);if(result){if(successFn){var results=[];for(var i=0;i<result.rows.length;i++){results.push(result.rows.item(i));}
successFn(results);}}};return that;};persistence.db.gears={};persistence.db.gears.connect=function(dbname){var that={};var conn=google.gears.factory.create('beta.database');conn.open(dbname);that.transaction=function(fn){fn(persistence.db.gears.transaction(conn));};return that;};persistence.db.gears.transaction=function(conn){var that={};that.executeSql=function(query,args,successFn,errorFn){if(persistence.debug){console.log(query,args);}
var rs=conn.execute(query,args);if(successFn){var results=[];while(rs.isValidRow()){var result={};for(var i=0;i<rs.fieldCount();i++){result[rs.fieldName(i)]=rs.field(i);}
results.push(result);rs.next();}
successFn(results);}};return that;};persistence.db.connect=function(dbname,description,size){if(persistence.db.implementation=="html5"){return persistence.db.html5.connect(dbname,description,size);}else if(persistence.db.implementation=="html5-sync"){return persistence.db.html5Sync.connect(dbname,description,size);}else if(persistence.db.implementation=="gears"){return persistence.db.gears.connect(dbname);}};persistence.store.websql.sqliteDialect={createTable:function(tableName,columns){var tm=persistence.typeMapper;var sql="CREATE TABLE IF NOT EXISTS `"+tableName+"` (";var defs=[];for(var i=0;i<columns.length;i++){var column=columns[i];defs.push("`"+column[0]+"` "+tm.columnType(column[1])+(column[2]?" "+column[2]:""));}
sql+=defs.join(", ");sql+=')';return sql;},createIndex:function(tableName,columns,options){options=options||{};return"CREATE "+(options.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+tableName+"__"+columns.join("_")+"` ON `"+tableName+"` ("+
columns.map(function(col){return"`"+col+"`";}).join(", ")+")";}};persistence.store.sql.config(persistence,persistence.store.websql.sqliteDialect);conn=persistence.db.connect(dbname,description,size);if(!conn){throw new Error("No supported database found in this browser.");}};try{exports.persistence=persistence;}catch(e){}